{% extends "base_public.html" %}

{% block head %}
{% load static %}

<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>

{% endblock %}


{% block content %}

<script>
  let socket;
  let protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
  let prefix = protocol + window.location.host + "/ws/snake/";
  let touchStartX = 0, touchStartY = 0;
  document.body.onload = setup;

  function setup() {
    $("#start-form").submit(startGame);
  }

  function setupGame(name, hall) {
    connect(name, hall);


    document.addEventListener("keydown", function (e) {
      keyDownHandler(e);
    }, false);
    document.addEventListener("touchstart", function (e) {
      touchStart(e.changedTouches[0]);
    }, false);
    document.addEventListener("touchend", function (e) {
      touchEnd(e.changedTouches[0]);
    }, false);
  }

  function startGame(e) {
    e.preventDefault();
    $("#start-form").hide()
    $("#score").show()

    let formData = new FormData(document.querySelector('#start-form'))
    let name = formData["name"];
    let hall = formData["hall"];

    if (!name) name = "";
    if (!hall) hall = "";

    console.log(name);
    console.log(hall);

    setupGame(name, hall);
  }

  function receiveMessage(messageObject) {
    msg = JSON.parse(messageObject.data);

    if (msg.msg === "score") {
      updateScore(msg.score);
    } else if (msg.msg === "game_over") {
      gameOver(); // TODO
    } else if (msg.msg === "color") {
      updateColor(msg.color); // TODO
    }
  }

  function updateScore(score) {
    let scoreSpan = document.getElementById("score");

    scoreSpan.innerText = score;
  }

  function gameOver() {
    let scoreSpan = document.getElementById("score");

    scoreSpan.innerText = "Game over!\n Score: " + scoreSpan.innerText;
  }

  function updateColor(color) {
    console.log(color);
    $("body").css("background-color", "rgb(" + color[0] + ","
                  + color[1] + "," + color[2] + ")");
  }

  function touchStart(e) {
    touchStartX = e.clientX;
    touchStartY = e.clientY;
  }

  function touchEnd(e) {
    let endX = e.clientX;                                    
    let endY= e.clientY;

    let diffX = touchStartX - endX;
    let diffY = touchStartY - endY;

    if (Math.abs(diffX) > Math.abs(diffY)) {
      if (diffX > 0) {
        send("w");
      } else {
        send("e");
      }
    } else {
      if (diffY > 0) {
        send("n");
      } else {
        send("s");
      }
    }
  }

  function keyDownHandler(e) {
    if (e.key == "Right" || e.key == "ArrowRight" || e.key == "d") {
      send("e")
    } else if (e.key == "Left" || e.key == "ArrowLeft" || e.key == "a") {
      send("w")
    } else if (e.key == "Up" || e.key == "ArrowUp" || e.key == "w") {
      send("n")
    } else if (e.key == "Down" || e.key == "ArrowDown" || e.key == "s") {
      send("s")
    }
  }


  function connect(name, hall) {
    socket = new WebSocket(prefix + "connect/")
    socket.addEventListener('message', receiveMessage);

    socket.onopen = function () {
      socket.send(JSON.stringify({msg: "new",
                                  name: name,
                                  hall: hall}));
    };
  }

  function send(dir) {
    socket.send(JSON.stringify({ msg: "dir",
                                 direction: dir }))
  }
</script>

<style>
  .attention {
      color: black;
      background-color: #fff28f;
      padding: 0.2em;
      box-decoration-break: clone;
  }
  .explanation img {


      background-color: #ccc;
  }
</style>

<div id="start-screen">
  <div class="row justify-content-between explanation" hidden>
    <div class="col-4 card">
      <img class="card-img-top"
        src="/static/img/snake/explanation-1.png">
      <p class="card-body">
        Don't look at your phone, look at the <span class="attention">Leddie screen on the window</span>!
      </p>
    </div>
    <div class="col-4 card">
      <img class="card-img-top"
        src="/static/img/snake/explanation-2.png">
      <p class="card-body">
        Change direction by swiping on <span class="attention">your
          phone</span>
      </p>
    </div>
    <div class="col-4 card">
      <img class="card-img-top"
        src="/static/img/snake/explanation-3.png">
      <p class="card-body">
        Avoid obstacles and collect food to score points!
      </p>
    </div>
  </div>

  <form id="start-form">
    <div class="mb-3 row">
      <div class="col">
        <label class="form-label">
          Name
        </label>
        <input class="form-control"
               type="text"
               maxlength="3"
               placeholder="ABC"
               name="name"
               >
      </div>
      <div class="col">
        <label class="form-label">
          Hall
        </label> 
        <input class="form-control"
               type="number"
               min="1"
               max="150"
               placeholder="99"
               name="hall"
               >
      </div>
    </div>

    <div class="mb-3 text-center">
      <button type="submit" class="btn btn-success fs-1">Play</button>
    </div>
  </form>

  <h1 id="score" class="display-1 text-center" style="display: none">0</h1>
</div>

{% endblock %}
